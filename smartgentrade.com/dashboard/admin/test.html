<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard · SmartGen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --bg: #f5f7fb;
      --card: #fff;
      --muted: #8a94a6;
      --accent: #2b6ef6;
      --danger: #e74c3c;
      --success: #28a745;
      --glass: rgba(255,255,255,0.6);
      --shadow: rgba(2,6,23,0.08);
      --text: #0d1117;
    }
    body.dark {
      --bg: #0f1720;
      --card: #111318;
      --muted: #9aa4b2;
      --accent: #f5b400;
      --danger: #e0524c;
      --success: #29c77d;
      --glass: rgba(255,255,255,0.02);
      --shadow: rgba(0,0,0,0.6);
      --text: #e6eef8;
    }

    *{box-sizing:border-box;font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial,sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);transition:background .25s,color .25s}
    .app {
      display:flex;
      height:100vh;
      gap:20px;
      padding:16px;
    }

    /* Sidebar */
    .sidebar {
      width:250px;
      background:var(--card);
      border-radius:12px;
      padding:16px;
      box-shadow: 0 6px 18px var(--shadow);
      display:flex;
      flex-direction:column;
      gap:12px;
      flex-shrink:0;
    }
    .brand { font-weight:700; color:var(--accent); font-size:1.1rem; }
    .nav { display:flex;flex-direction:column; gap:6px; margin-top:6px; overflow:auto }
    .nav a {
      padding:10px 12px; border-radius:8px; color:inherit; text-decoration:none; display:flex; gap:10px; align-items:center;
    }
    .nav a:hover { background: rgba(0,0,0,0.03); }
    .nav a.active { background: linear-gradient(90deg, rgba(0,0,0,0.04), rgba(0,0,0,0.02)); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); font-weight:600; }

    .content {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    header.topbar {
      height:64px;
      background:var(--card);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      border-radius:12px;
      box-shadow: 0 6px 18px var(--shadow);
    }
    .top-actions { display:flex; gap:12px; align-items:center; }
    .search { padding:8px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--text); }
    .btn {
      padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--accent); color:white; font-weight:600;
    }
    .btn.ghost { background:transparent; color:var(--text); border:1px solid rgba(0,0,0,0.06) }
    .main-area {
      flex:1;
      overflow:auto;
      padding:14px;
    }

    .card {
      background:var(--card);
      border-radius:12px;
      padding:16px;
      box-shadow: 0 6px 18px var(--shadow);
    }

    .grid { display:grid; gap:12px; grid-template-columns: repeat(3,1fr); }
    .grid .card { padding:18px; }

    table { width:100%; border-collapse:collapse; font-size:14px; }
    table thead tr { background:var(--glass); }
    table thead th { text-align:left; padding:10px; color:var(--muted); font-weight:600; }
    table tbody td { padding:10px; border-bottom:1px solid rgba(0,0,0,0.04); }

    .table-wrapper { overflow-x: auto; max-height: 520px; width: 100%; -webkit-overflow-scrolling: touch; }

    .badge { padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; display:inline-block; }
    .badge.green { background: rgba(40,167,69,0.12); color:var(--success); }
    .badge.red { background: rgba(231,76,60,0.12); color:var(--danger); }
    .muted { color:var(--muted); font-size:13px; }

    /* Small screens */
    @media (max-width:1000px) {
      .app { padding: 8px; flex-direction: column; }
      
      .content { width: 100%; padding: 0; }
      
      .main-area { padding: 8px; }
      
      .grid { grid-template-columns: 1fr; }
      
      .form-row { flex-direction: column; }
      
      .input { width: 100%; }
      
      table { min-width: 100%; font-size: 13px; }
      
      .table-wrapper { margin: 0 -8px; padding: 0 8px; }
      
      .action-group { flex-wrap: wrap; }
      
      .sidebar { display: flex !important; }
    }

    /* compact helpers */
    .row { display:flex; gap:12px; align-items:center; }
    .col { display:flex; flex-direction:column; gap:6px; }
    .form-row { display:flex; gap:12px; }
    .input { padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--text); min-width:0; }
    .action-group { display:flex; gap:8px; }

    /* Theme toggler styles */
    .theme-toggle { padding:8px 10px; border-radius:8px; cursor:pointer; border:none; }
    .section-title { font-size:1.1rem; font-weight:700; margin-bottom:8px; }

    /* small button styles */
    .small-btn { padding:6px 8px; border-radius:6px; cursor:pointer; border:none; font-weight:600; }
    .small-btn.primary { background:var(--accent); color:white; }
    .small-btn.danger { background:var(--danger); color:white; }
    .small-btn.success { background:var(--success); color:white; }

    /* table action buttons */
    .table-btn { padding:6px 8px; border-radius:6px; cursor:pointer; border:none; font-weight:600; margin-right:6px; }
    .table-btn.primary { background:#2563eb;color:white; }
    .table-btn.warn { background:#f59e0b;color:white; }
    .table-btn.danger { background:#ef4444;color:white; }

    /* make .table-body rows nicely spaced */
    .table-body tr:hover { background: rgba(0,0,0,0.02); }

    /* 💡 HAMBURGER + CLOSE ICON STYLES */
@media(max-width:1000px){
  .sidebar{
    position:fixed;top:0;left:0;height:100vh;width:240px;border-radius:0;
    transform:translateX(-110%);
    transition:transform .3s ease-in-out;
  }
  /* hide sidebar when not active */
.hidden {
  transform: translateX(-110%);
}

  .sidebar.show{transform:translateX(0);} /* Show sidebar when toggled */

  .hamburger{
    display:flex;flex-direction:column;gap:5px;cursor:pointer;
    background:none;border:none;padding:8px;
  }
  .hamburger span{
    width:24px;height:3px;background:var(--text);border-radius:2px;transition:.3s;
  }

  /* 💡 CLOSE BUTTON INSIDE SIDEBAR */
  .close-btn{
    position:absolute;top:12px;right:12px;background:none;
    border:none;font-size:24px;color:var(--text);cursor:pointer;
  }
}

/* =============================
   📱 Mobile Sidebar + Hamburger
   ============================= */
@media (max-width: 1000px) {
  /* Sidebar slides in from left */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 250px;
    height: 100vh;
    background: var(--card);
    border-radius: 0;
    box-shadow: 2px 0 15px var(--shadow);
    transform: translateX(-110%);
    transition: transform 0.3s ease-in-out;
    z-index: 1000;
    padding: 1rem;
  }

  /* When shown */
  .sidebar.show {
    transform: translateX(0);
  }

  /* Hidden state */
  .sidebar.hidden {
    transform: translateX(-110%);
  }

  /* Close button (X) */
  .close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: none;
    border: none;
    font-size: 28px;
    color: var(--text);
    cursor: pointer;
  }

  /* Hamburger icon */
  .hamburger {
    display: flex;
    flex-direction: column;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
  }

  .hamburger span {
    width: 25px;
    height: 3px;
    background: var(--text);
    border-radius: 2px;
    transition: 0.3s;
  }
}

/* Hide hamburger on desktop */
@media (min-width: 1001px) {
  .hamburger {
    display: none !important;
  }
}

  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar card" id="sidebar">
         <button class="close-btn" id="closeSidebar">&times;</button>
 
      <div class="brand">SmartGen · Admin</div>
      <div class="muted">Control center</div>
      <nav class="nav" id="mainNav">
        <a href="#" data-section="dashboard-overview" class="active">Dashboard Overview</a>
        <a href="#" data-section="active-users">Active Users</a>
        <a href="#" data-section="kyc-center">KYC Center</a>
        <a href="#" data-section="referrals">Referrals</a>
        <a href="#" data-section="deposits">Deposits</a>
        <a href="#" data-section="traders-list">Traders List</a>
        <a href="#" data-section="investment-plans">Investment Plans</a>
        <a href="#" data-section="create-trader">Create Trader</a>
        <a href="#" data-section="edit-trader">Edit Trader</a>
        <a href="#" data-section="all-trades">All Trades</a>
        <a href="#" data-section="edit-user">Edit User</a>
        <a href="#" data-section="withdrawal-requests">Withdrawal Requests</a>
      </nav>
      <div style="margin-top:auto; display:flex; gap:8px; align-items:center;">
        <button id="toggleTheme" class="theme-toggle">Toggle theme</button>
        <button id="logoutBtn" class="small-btn">Logout</button>
      </div>
    </aside>

    <div class="content">
      <!-- <header class="topbar">
        <div style="display:flex;gap:12px;align-items:center">
          <input id="globalSearch" class="search" placeholder="Search users, trades, assets...">
        </div>
        <div class="top-actions">
          <div class="muted">Admin</div>
          <div class="avatar" style="width:40px;height:40px;border-radius:8px;background:var(--glass);"></div>
        </div>
      </header> -->
      <header class="topbar">
  <div style="display:flex;gap:12px;align-items:center">
    <!-- 💡 HAMBURGER BUTTON (Visible only on mobile) -->
    <button class="hamburger" id="hamburger" style="display:none;">
      <span></span><span></span><span></span>
    </button>
    <input id="globalSearch" class="search" placeholder="Search users, trades, assets...">
  </div>
  <div class="top-actions">
    <div class="muted">Admin</div>
    <div class="avatar" style="width:40px;height:40px;border-radius:8px;background:var(--glass);"></div>
  </div>
</header>



      <main class="main-area">
        <!-- Dashboard Overview -->
        <section id="dashboard-overview" class="card section">
          <div class="section-title">Dashboard Overview</div>
          <div class="grid" id="dashboard-cards">
            <div class="card">
              <div class="muted">Registered Users</div>
              <div id="registered" style="font-size:1.6rem; font-weight:700">—</div>
            </div>
            <div class="card">
              <div class="muted">Total Deposited</div>
              <div id="totalDeposited" style="font-size:1.6rem; font-weight:700">—</div>
            </div>
            <div class="card">
              <div class="muted">Approved Deposits</div>
              <div id="approvedDeposits" style="font-size:1.6rem; font-weight:700">—</div>
            </div>
            <div class="card">
              <div class="muted">Pending Deposits</div>
              <div id="pendingDeposits" style="font-size:1.6rem; font-weight:700">—</div>
            </div>
            <div class="card">
              <div class="muted">Approved Withdrawals</div>
              <div id="approvedWithdrawals" style="font-size:1.6rem; font-weight:700">—</div>
            </div>
            <div class="card">
              <div class="muted">Pending Withdrawals</div>
              <div id="pendingWithdrawals" style="font-size:1.6rem; font-weight:700">—</div>
            </div>
          </div>
          <!-- small recent activity -->
          <div style="margin-top:12px" class="card">
            <div class="muted">Recent activity</div>
            <div id="recentActivity" class="muted">No activity loaded.</div>
          </div>
        </section>

        <!-- Active Users -->
        <section id="active-users" class="card section" style="display:none">
          <div class="section-title">Active Users</div>
          <div class="table-wrapper card" style="padding:12px 14px;">
            <table>
              <thead>
                <tr><th>Name</th><th>Balance</th><th>Profit</th><th>View</th><th>Copy History</th><th>Delete</th></tr>
              </thead>
              <tbody class="table-body"></tbody>
            </table>
          </div>
          <div id="activeUsersMessage" class="muted" style="margin-top:8px"></div>
        </section>

        <!-- KYC Center -->
        <section id="kyc-center" class="card section" style="display:none">
          <div class="section-title">KYC Verification Center</div>
          <div id="imageElement" class="card" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:12px;"></div>
          <div class="card" style="margin-top:12px;">
            <div class="muted">Recent transactions  </div>
            <div class="table-wrapper">
              <table>
                <thead><tr><th>From</th><th>Amount</th><th>Action</th></tr></thead>
                <tbody class="table-body"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Referrals -->
        <section id="referrals" class="card section" style="display:none">
          <div class="section-title">Referrals</div>
          <div class="card row" style="align-items:center;justify-content:space-between">
            <div>
              <div id="username" style="font-weight:700">—</div>
              <div id="email" class="muted">—</div>
            </div>
            <div>
              <div class="muted">Referral code</div>
              <input id="myInput" class="input" readonly style="width:220px" />
              <button id="copyReferral" class="btn ghost">Copy</button>
            </div>
          </div>
          <div class="card" style="margin-top:12px;">
            <div class="muted">Referred Users</div>
            <div class="table-wrapper">
              <table>
                <thead><tr><th>Email</th></tr></thead>
                <tbody class="table-body"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Deposits -->
        <section id="deposits" class="card section" style="display:none">
          <div class="section-title">Deposits</div>
          <div class="table-wrapper card">
            <table>
              <thead><tr><th>From</th><th>Amount</th><th>Method</th></tr></thead>
              <tbody class="table-body"></tbody>
            </table>
          </div>
        </section>

        <!-- Traders List -->
        <section id="traders-list" class="card section" style="display:none">
          <div class="section-title">Traders List</div>
          <div class="table-wrapper card">
            <table>
              <thead><tr><th>Name</th><th>ID</th><th>Create Signal</th><th>Edit Profile</th></tr></thead>
              <tbody class="table-body"></tbody>
            </table>
          </div>
        </section>

        <!-- Investment Plans -->
        <section id="investment-plans" class="card section" style="display:none">
          <div class="section-title">Investment Plans</div>
          <div class="table-wrapper card">
            <table>
              <thead><tr><th>From</th><th>Amount</th><th>Plan</th><th>Action</th></tr></thead>
              <tbody class="table-body"></tbody>
            </table>
          </div>
        </section>

        <!-- Create Trader -->
        <section id="create-trader" class="card section" style="display:none">
          <div class="section-title">Create Trader</div>
          <div class="card" style="display:flex;gap:12px">
            <div style="flex:1">
              <label class="muted">Name</label><input id="name" class="input" />
              <label class="muted">Level</label><input id="level" class="input" />
              <label class="muted">Rating</label><input id="rating" class="input" />
              <label class="muted">Commission</label><input id="commission" class="input" />
              <label class="muted">PNL</label><input id="pnl" class="input" />
            </div>
            <div style="flex:1">
              <label class="muted">Profile ID</label><input id="profileId" class="input" />
              <label class="muted">Account Level</label><input id="accountLevel" class="input" />
              <label class="muted">Type</label><input id="type" class="input" />
              <label class="muted">Followers</label><input id="followers" class="input" />
              <label class="muted">Watchers</label><input id="watchers" class="input" />
              <label class="muted">Profitable Trades</label><input id="profitableTrade" class="input" />
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="muted">Upload Photo</div>
            <input id="image-upload" type="file" accept="image/*" />
            <div id="image-preview" style="margin-top:8px;padding:12px;border-radius:8px;background:var(--glass);max-width:220px;">
              <img id="uploaded-image" src="" alt="" style="width:100%;display:none;border-radius:8px;" />
            </div>
            <div style="margin-top:12px">
              <button id="registerBtn" class="btn">Create Trader</button>
              <div class="live-section muted" style="display:inline-block;margin-left:12px"></div>
            </div>
          </div>
        </section>

        <!-- Edit Trader -->
        <section id="edit-trader" class="card section" style="display:none">
          <div class="section-title">Edit Trader</div>
          <div class="card">
            <div class="form-row">
              <div style="flex:1">
                <label class="muted">Name</label><input id="name_edit" class="input" />
                <label class="muted">Level</label><input id="level_edit" class="input" />
                <label class="muted">Rating</label><input id="rating_edit" class="input" />
                <label class="muted">Commission</label><input id="commission_edit" class="input" />
              </div>
              <div style="flex:1">
                <label class="muted">PNL</label><input id="pnl_edit" class="input" />
                <label class="muted">Profile ID</label><input id="profileId_edit" class="input" />
                <label class="muted">Followers</label><input id="followers_edit" class="input" />
                <label class="muted">Watchers</label><input id="watchers_edit" class="input" />
              </div>
            </div>
            <div style="margin-top:12px">
              <button id="updateTraderBtn" class="btn primary">Update Trader</button>
              <div class="live-section muted" style="display:inline-block;margin-left:12px"></div>
            </div>
          </div>
        </section>

        <!-- All Trades -->
        <section id="all-trades" class="card section" style="display:none">
          <div class="section-title">All Trades</div>
          <div class="table-wrapper card" style="padding:12px;">
            <table>
              <thead><tr><th>Owner</th><th>Asset</th><th>Amount</th><th>Leverage</th><th>Duration</th><th>Countdown</th><th>P/L</th><th>Result</th><th>Status</th><th>Command</th><th>Actions</th></tr></thead>
              <tbody id="tradeTable"></tbody>
            </table>
          </div>
        </section>

        <!-- Edit User -->
        <section id="edit-user" class="card section" style="display:none">
          <div class="section-title">Edit User Info</div>
          <div class="card form-row">
            <div style="flex:1">
              <label class="muted">First name</label><input id="firstName" class="input" />
              <label class="muted">Last name</label><input id="lastName" class="input" />
              <label class="muted">Email</label><input id="email_user" class="input" />
              <label class="muted">Balance</label><input id="balance" class="input" />
              <label class="muted">Profit</label><input id="profit" class="input" />
            </div>
            <div style="flex:1">
              <label class="muted">Country</label><input id="country" class="input" />
              <label class="muted">Copytrading</label><input id="copytrading" class="input" />
              <label class="muted">KYC</label><input id="kyc" class="input" />
              <label class="muted">Referral Bonus</label><input id="referalBonus" class="input" />
              <label class="muted">_id</label><input id="_id" class="input" readonly />
              <div style="margin-top:12px">
                <button id="enableBtn" class="small-btn success">Enable</button>
                <button id="disableBtn" class="small-btn danger">Disable</button>
                <button id="updateBtn_user" class="btn">Save</button>
                <div class="live-section muted" style="display:inline-block;margin-left:12px"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Withdrawal Requests -->
        <section id="withdrawal-requests" class="card section" style="display:none">
          <div class="section-title">Withdrawal Requests</div>
          <div class="table-wrapper card" style="padding:12px;">
            <table>
              <thead><tr><th>From</th><th>Amount</th><th>Method</th><th>Address</th><th>Status</th><th>Approve</th><th>Decline</th></tr></thead>
              <tbody class="table-body"></tbody>
            </table>
          </div>
        </section>

      </main>
    </div>
    <script>
document.addEventListener("DOMContentLoaded", () => {
  const sidebar = document.getElementById("sidebar");
  const hamburger = document.getElementById("hamburger");
  const closeSidebar = document.getElementById("closeSidebar");

  function handleResize() {
    if (window.innerWidth <= 1000) {
      hamburger.style.display = "flex";
      sidebar.classList.add("hidden");
    } else {
      hamburger.style.display = "none";
      sidebar.classList.remove("hidden", "show");
    }
  }

  window.addEventListener("resize", handleResize);
  handleResize();

  // ✅ Open sidebar
  hamburger.addEventListener("click", () => {
    sidebar.classList.add("show");
    sidebar.classList.remove("hidden");
  });

  // ✅ Close sidebar
  closeSidebar.addEventListener("click", () => {
    sidebar.classList.remove("show");
    sidebar.classList.add("hidden");
  });
});
</script>

  </div>


  <!-- SCRIPT: UI Shell -->
  <script>
    // SECTION NAV
    function showSection(id) {

        
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      const el = document.getElementById(id);
      if (el) el.style.display = 'block';
      // update nav active
      document.querySelectorAll('#mainNav a').forEach(a => a.classList.remove('active'));
      const navLink = document.querySelector(`#mainNav a[data-section="${id}"]`);
      if (navLink) navLink.classList.add('active');
      // scroll main area top
      document.querySelector('.main-area').scrollTop = 0;
    }
    document.querySelectorAll('#mainNav a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const s = a.getAttribute('data-section');
        showSection(s);
      });
    });

    // THEME
    const themeBtn = document.getElementById('toggleTheme');
    function setTheme(theme) {
      if (theme === 'dark') document.body.classList.add('dark');
      else document.body.classList.remove('dark');
      localStorage.setItem('admin_theme', theme);
    }
    const stored = localStorage.getItem('admin_theme') || 'dark';
    setTheme(stored);
    themeBtn.addEventListener('click', ()=>{
      const next = document.body.classList.contains('dark') ? 'light' : 'dark';
      setTheme(next);
    });

    // copy referral
    document.getElementById('copyReferral').addEventListener('click',()=>{
      const el = document.getElementById('myInput');
      el.select(); el.setSelectionRange(0, 99999);
      navigator.clipboard.writeText(el.value).then(()=>{ alert('Copied'); });
    });

    // logout
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('user'); alert('Logged out'); location.reload();
    });

    // expose showSection globally for scripts
    window.showSection = showSection;
  </script>

  <!-- ---------------------------
       USER SCRIPTS INTEGRATION
       Each major script block you provided is included here.
       I wrapped them into self-invoking functions to avoid collisions,
       and I exposed action functions (used by onclick) to window where needed.
       --------------------------- -->

  <!-- Script 1: Landing page + system metrics -->
  <script>
  (async function LandingPageScript(){
    async function fetchUserInfo() {
      var parsedData = localStorage.getItem('user')
      var user = JSON.parse((parsedData))
      return user;
    }

    async function fetchUser() {
      const response = await $.ajax({
        type: "GET",
        url: 'https://smartgen-render.onrender.com/users',
        dataType: "json",
        timeout: 30000,
      });

      // sometimes API returns object with data property
      const data = response && response.data ? response.data : response;
      console.log('Landing fetched users:', data);
      return data;
    }

    function internal_sendUserDetail(user){
      // original behavior stored user and navigated to userinfo page.
      // adapt: store and show edit-user section
      localStorage.setItem("user", user);
      // if userinfo.html existed you'd go there, but here we open Edit User view
      try { showSection('edit-user'); } catch(e){}
    }
    // expose it
    window.landing_sendUserDetail = internal_sendUserDetail;

    $(document).ready(async function () {
      // fetch current user info from localStorage
      const userInfo = await fetchUserInfo().catch(()=>null);
      if (userInfo) {
        $('#username').html((userInfo.firstName || '') + " " + (userInfo.lastName || ''));
        $('#email').html(userInfo.email || '');
      }

      const users = await fetchUser().catch(()=>[]);
      const registeredUsers = users.length || 0;
      $('#registered').html(registeredUsers);

      let approvedDeposits = 0;
      let pendingDeposits = 0;
      let approvedWithdrawals = 0;
      let pendingWithdrawals = 0;
      let totalDeposited = 0;
      let withdrawnTotal = 0;

      users.forEach(user => {
        (user.transactions || []).forEach(tx => {
          if (tx.status === "Approved") {
            approvedDeposits += 1;
            totalDeposited += Number(tx.amount || 0);
          } else if (tx.status === "pending") {
            pendingDeposits += 1;
          }
        });
        (user.withdrawals || []).forEach(wd => {
          if (wd.status === "Approved") {
            approvedWithdrawals += 1;
            withdrawnTotal += Number(wd.amount || 0);
          } else if (wd.status === "pending") {
            pendingWithdrawals += 1;
          }
        });
      });

      $('#totalDeposited').html("$" + totalDeposited);
      $('#approvedDeposits').html(approvedDeposits);
      $('#pendingDeposits').html(pendingDeposits);
      $('#approvedWithdrawals').html(approvedWithdrawals);
      $('#pendingWithdrawals').html(pendingWithdrawals);

      $('#recentActivity').text(`Loaded ${registeredUsers} users.`);
    });
  })();
  </script>

  <!-- Script 2: Active users -->
  <script>
  (function ActiveUsersScript(){

    const BASE_URL = "https://smartgen-render.onrender.com";
    
    async function fetchUser() {
          const response = await $.ajax({
            type: "GET",
            url: 'https://smartgen-render.onrender.com/users',
            dataType: "json",
            timeout: 30000,
          });
          const data = response && response.data ? response.data : response;
          return data;
    }

    async function fetchUserInfo_local() {
    try {
      const stored = localStorage.getItem("updatedUseremal");
      if (!stored) return null;

      const useremm = stored.trim().replace(/^"|"$/g, '');
     

      // Optionally refetch latest data from backend
      const response = await $.ajax({
        type: "GET",
        url: `${BASE_URL}/users/${useremm}`,
        dataType: "json",
        timeout: 30000,
      });

      const data = response && response.data ? response.data : response;
      localStorage.setItem("updatedUser", JSON.stringify(data)); // keep latest

      
      return data;
    } catch (err) {
      console.error("Error in fetchUserInfo_local:", err);
      return null;
    }
  }

  function sendEdUserDetail(user) {
  localStorage.setItem("updatedUseremal", JSON.stringify(user));
  showSection('edit-user');

  // ensure correct user loads immediately
  setTimeout(() => window.populateEditUserForm && window.populateEditUserForm(), 200);
}
    function pushUserDetail(userem){
      localStorage.setItem("userem",userem);
      // open copy history area (we don't have a dedicated view, open deposits)
      showSection('deposits');
    }

    async function deleteUser(userem){
      var userconfirmed=  confirm("ARE YOU SURE YOU WANT TO DELETE THIS USER" +" "+ userem)
      if (userconfirmed) {
        try {
          const response = await $.ajax({
            type: "DELETE",
            url: `https://smartgen-render.onrender.com/users/${userem}/delete`,
            dataType: "json",
            timeout: 30000,
          });
          $('.active-users .live-section').addClass("alert-danger").text("User deleted successfully");
          alert("User Deleted");
          setTimeout(function () { showSection('active-users'); loadActiveUsers(); }, 1200);
        } catch(err) {
          alert("Failed to delete user: "+err);
        }
      } else { alert("kept") }
    }

    // expose for onclick from DOM
    window.sendEdUserDetail = sendEdUserDetail;
    window.pushUserDetail = pushUserDetail;
    window.deleteUser = deleteUser;

    async function loadActiveUsers() {
      const users = await fetchUser().catch(()=>[]);
      const tbl = document.querySelector('#active-users .table-body');
      tbl.innerHTML = '';
      users.forEach(function (user) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.firstName || ''}</td>
          <td>$${user.balance || 0}</td>
          <td>$${user.profit || 0}</td>
          <td><button class="table-btn primary" onclick="sendEdUserDetail('${user.email}')">View</button></td>
          <td><button class="table-btn primary" onclick="pushUserDetail('${user.email}')">Copy</button></td>
          <td><button class="table-btn danger" onclick="deleteUser('${user.email}')">Delete</button></td>
        `;
        tbl.appendChild(tr);
      });
    }

    // load initially when document ready
    $(document).ready(function(){ loadActiveUsers(); });
    // also expose loader
    window.loadActiveUsers = loadActiveUsers;
  })();
  </script>
<style>
    /* Deposit table buttons */
.table-body a.btn-primary {
  display: inline-block;
  padding: 6px 12px;
  margin-right: 6px;
  border-radius: 6px;
  font-weight: 600;
  text-decoration: none;
  color: white;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
  font-size: 0.85rem;
}

/* Approve button */
.table-body a.btn-primary:nth-child(1) {
  background-color: var(--success);
}

.table-body a.btn-primary:nth-child(1):hover {
  background-color: #1e7e34; /* slightly darker green */
  transform: scale(1.05);
}

/* Decline button */
.table-body a.btn-primary:nth-child(2) {
  background-color: var(--danger);
}

.table-body a.btn-primary:nth-child(2):hover {
  background-color: #c82333; /* slightly darker red */
  transform: scale(1.05);
}

/* User Info button */
.table-body a.btn-primary:nth-child(3) {
  background-color: var(--accent);
}

.table-body a.btn-primary:nth-child(3):hover {
  background-color: #1a5cd6; /* slightly darker accent */
  transform: scale(1.05);
}
.small-btn.warning {
  background: #f59e0b;
  color: #fff;
  border: none;
  border-radius: 5px;
  padding: 6px 10px;
  cursor: pointer;
  transition: 0.2s ease-in-out;
}
.small-btn.warning:hover {
  background: #d97706;
  transform: scale(1.05);
}

/* Optional: Add spacing and smaller font for mobile */
@media (max-width: 1000px) {
  .table-body a.btn-primary {
    font-size: 0.75rem;
    padding: 4px 8px;
    margin-bottom: 4px;
    display: inline-block;
  }

  .small-btn.warning {
  background: #f59e0b;
  color: #fff;
  border: none;
  border-radius: 5px;
  padding: 6px 10px;
  cursor: pointer;
  transition: 0.2s ease-in-out;
}
.small-btn.warning:hover {
  background: #d97706;
  transform: scale(1.05);
}

}

</style>
  <!-- Script 3: KYC page -->
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    

// ✅ Approve (Verify) KYC
async function verifyDocument(userId) {
  if (!confirm("Approve this user's KYC verification?")) return;

  try {
    const response = await $.ajax({
      type: "PUT",
      url: `${BASE_URL}/transactions/${userId}/kyc/approve`,
      dataType: "json",
      timeout: 30000,
    });

    if (response.success) {
      Swal.fire({
        icon: "success",
        title: "KYC Approved",
        text: "The user's KYC has been verified successfully.",
        confirmButtonColor: "#10B981",
      });
      // Refresh your user list or section
      fetchUser(); 
    } else {
      Swal.fire({
        icon: "error",
        title: "Approval Failed",
        text: response.message || "Could not approve KYC.",
      });
    }
  } catch (err) {
    console.error("Error approving KYC:", err);
    Swal.fire({
      icon: "error",
      title: "Server Error",
      text: "An error occurred while approving the KYC.",
    });
  }
}

// ❌ Reject KYC
async function rejectDocument(userId) {
  const { value: reason } = await Swal.fire({
    title: "Reject KYC Verification",
    input: "text",
    inputLabel: "Reason for rejection (optional)",
    inputPlaceholder: "Enter reason...",
    showCancelButton: true,
    confirmButtonText: "Reject",
    confirmButtonColor: "#EF4444",
  });

  if (reason === undefined) return; // user canceled

  try {
    const response = await $.ajax({
      type: "PUT",
      url: `${BASE_URL}/transactions/${userId}/kyc/reject`,
      data: JSON.stringify({ reason }),
      contentType: "application/json",
      dataType: "json",
      timeout: 30000,
    });

    if (response.success) {
      Swal.fire({
        icon: "success",
        title: "KYC Rejected",
        text: "The user has been notified of the rejection.",
        confirmButtonColor: "#EF4444",
      });
      fetchUser(); 
    } else {
      Swal.fire({
        icon: "error",
        title: "Rejection Failed",
        text: response.message || "Could not reject KYC.",
      });
    }
  } catch (err) {
    console.error("Error rejecting KYC:", err);
    Swal.fire({
      icon: "error",
      title: "Server Error",
      text: "An error occurred while rejecting the KYC.",
    });
  }
}
async function fetchImages() {
      try {
        const response = await fetch('https://smartgen-render.onrender.com/auth/kyc/fetch-images');
        if (response.ok) {
          const images = await response.json();
          displayImages(images);
        } else {
          console.error('Error fetching images:', response.status);
        }
      } catch (error) { console.error('Error fetching images:', error); }
    }

async function deleteImage(imageId) {
  if (!confirm("Are you sure you want to delete this image?")) return;

  try {
    const response = await fetch(`https://smartgen-render.onrender.com/auth/kyc/delete-image/${imageId}`, {
      method: "DELETE",
    });

    const result = await response.json();

    if (response.ok && result.success) {
      alert("✅ Image deleted successfully.");
      fetchImages(); // Refresh list
    } else {
      alert("❌ Error deleting image: " + (result.message || "Unknown error"));
    }
  } catch (err) {
    console.error("Error deleting image:", err);
    alert("Server error deleting image.");
  }
}

  (function KycScript(){
    function displayImages(images) {
       console.log('KYC images', images);
       $('#imageElement').empty();
       images.forEach(image => { 
  const container = $(`
    <div class="card" style="padding:8px; position: relative;">
      <img src="${image.imageUrl}" style="width:100%;height:160px;object-fit:cover;border-radius:8px" />
      <div style="margin-top:8px">
        <div style="font-weight:700">${image.owner}</div>
        <div class="muted">Document: ${image.docNum}</div>
        <div style="margin-top:8px; display:flex; gap:6px;">
          <button class="small-btn success" onclick="verifyDocument('${image.ownerdet}')">Verify</button>
          <button class="small-btn danger" onclick="rejectDocument('${image.ownerdet}')">Reject</button>
          <button class="small-btn warning" onclick="deleteImage('${image._id}')">Delete</button>
        </div>ownerdet
      </div>
    </div>
  `);
  $('#imageElement').append(container);
});

    }
function displayImages(images) {
       console.log('KYC images', images);
       $('#imageElement').empty();
       images.forEach(image => { 
  const container = $(`
    <div class="card" style="padding:8px; position: relative;">
      <img src="${image.imageUrl}" style="width:100%;height:160px;object-fit:cover;border-radius:8px" />
      <div style="margin-top:8px">
        <div style="font-weight:700">${image.owner}</div>
        <div class="muted">Document: ${image.docNum}</div>
        <div style="margin-top:8px; display:flex; gap:6px;">
          <button class="small-btn success" onclick="verifyDocument('${image.ownerdet}')">Verify</button>
          <button class="small-btn danger" onclick="rejectDocument('${image.ownerdet}')">Reject</button>
          <button class="small-btn warning" onclick="deleteImage('${image._id}')">Delete</button>
        </div>ownerdet
      </div>
    </div>
  `);
  $('#imageElement').append(container);
});

    }

    async function fetchImages() {
      try {
        const response = await fetch('https://smartgen-render.onrender.com/auth/kyc/fetch-images');
        if (response.ok) {
          const images = await response.json();
          displayImages(images);
        } else {
          console.error('Error fetching images:', response.status);
        }
      } catch (error) { console.error('Error fetching images:', error); }
    }

    async function fetchUser() {
      const response = await $.ajax({
        type: "GET",
        url: 'https://smartgen-render.onrender.com/users',
        dataType: "json",
        timeout: 30000,
      });
      const data = response && response.data ? response.data : response;
      return data;
    }

    function sendUserDetail(user) {
  localStorage.setItem("updatedUseremal", JSON.stringify(user));
  showSection('edit-user');

  // ensure correct user loads immediately
  setTimeout(() => window.populateEditUserForm && window.populateEditUserForm(), 200);
}

    // populate transactions table for kyc view
    async function loadKYCTransactions(){
      const users = await fetchUser().catch(()=>[]);
      const tbody = $('#kyc-center .table-body');
      tbody.empty();
      users.forEach(function(user){
        (user.transactions || []).forEach(function(transac){
          const row = $('<tr>');
          row.append(`<td>${transac.from}</td>`);
          row.append(`<td>$${transac.amount}</td>`);
        //   row.append(`<td><button class="table-btn primary" onclick="sendUserDetail('${user.email}')">User Info</button></td>`);
          tbody.append(row);
        });
      });
    }
function sendUserDetail(user) {
  localStorage.setItem("updatedUseremal", JSON.stringify(user));
  showSection('edit-user');

  // ensure correct user loads immediately
  setTimeout(() => window.populateEditUserForm && window.populateEditUserForm(), 200);
}
    // expose sendUserDetail to global (if needed)
    window.kyc_sendUserDetail = sendUserDetail;

    $(document).ready(function(){ fetchImages(); loadKYCTransactions(); });
  })();
  </script>

  <!-- Script 4: Referrals -->
  <script>
  (function ReferralsScript(){
    async function fetchUserInfo() {
      var parsedData = localStorage.getItem('user');
      var userFromLS = JSON.parse((parsedData || "{}"));
      if (!userFromLS || !userFromLS.email) return userFromLS;
      const response = await $.ajax({
        type: "GET",
        url: `https://smartgen-render.onrender.com/users/${userFromLS.email}`,
        dataType: "json",
        timeout: 30000,
        success: async function (data) {
        //   Object.assign(window.currentUserForRef, data.data || {});
          await localStorage.setItem("user", JSON.stringify(data.data || {}));
        },
        error: function () { /* ignore */ }
      });
      return response && response.data ? response.data : response;
    }

    async function loadReferrals(){
      const userInfo = await fetchUserInfo().catch(()=> (JSON.parse(localStorage.getItem('user') || '{}')));
      if (!userInfo) return;
      $("#username").html((userInfo.firstName||'') + " " + (userInfo.lastName||''));
      $("#email").html(userInfo.email||'');
      $("#accountBalance").html('$'+ (userInfo.balance||0));
      $("#profit").html('$'+ (userInfo.profit||0));
      $("#myInput").val(userInfo.referralCode || '');

      const tbody = $('#referrals .table-body');
      tbody.empty();
      (userInfo.referredUsers || []).forEach(function(u){
        const row = $('<tr>').append(`<td>${u}</td>`);
        tbody.append(row);
      });
    }

    $(document).ready(function(){ loadReferrals(); });
  })();
  </script>

  <!-- Script 5: Deposits -->
  <script>
  (function DepositsScript(){
  async function fetchUserTx(id) {
    const response = await $.ajax({
      type: "GET",
      url: `https://smartgen-render.onrender.com/transactions/${id}/deposit/history`,
      dataType: "json",
      timeout: 30000,
    });
    return response && response.data ? response.data : response;
  }

  async function fetchUserFromLocalStorage() {
    const parsedData = localStorage.getItem('user');
    const user = JSON.parse(parsedData || "{}");
    return user;
  }

  async function getAllUsers() {
    const response = await $.ajax({
      type: "GET",
      url: "https://smartgen-render.onrender.com/users",
      dataType: "json",
      timeout: 30000,
    });
    console.log(response.data);
    return response.data;
  }

  // Navigate to user info page
  window.openUserInfo = function(email) {
    localStorage.setItem("userem", email);
    showSection('edit-user');
    fetchUserInfo_local().then(() => {
      populateEditUserForm();
    });
  }

  // Decline a deposit
  window.declineDeposit = async function(userId, transactionId) {
    try {
      const response = await $.ajax({
        type: "PUT",
        url: `https://smartgen-render.onrender.com/transactions/${userId}/transactions/${transactionId}/decline`,
        dataType: "json",
        data: { _id: userId, transactionId },
        timeout: 30000
      });
      alert("Deposit Declined");
    
      return response.data;
    } catch (err) {
      console.error(err);
      alert("Error declining deposit");
    }
  }

  // Approve a deposit
  window.approveDeposit = async function(userId, transactionId) {
    try {
      const response = await $.ajax({
        type: "PUT",
        url: `https://smartgen-render.onrender.com/transactions/${userId}/transactions/${transactionId}/confirm`,
        dataType: "json",
        data: { _id: userId, transactionId },
        timeout: 30000
      });
      alert("Deposit Approved");
     
      return response.data;
    } catch (err) {
      console.error(err);
      alert("Error approving deposit");
    }
  }

  // Load all deposits into table
  async function loadDeposits() {
    const users = await getAllUsers();
    const tbody = $('#deposits .table-body');
    tbody.empty();

    users.forEach(user => {
      const transactions = user.transactions || [];
      transactions.forEach(tx => {
        const row = $('<tr>');
        row.append(`<td>${tx.from}</td>`);
        row.append(`<td>$${tx.amount}</td>`);
        row.append(`<td>${tx.method}</td>`);
        row.append(`<td>${tx.status}</td>`);
        row.append(`
          <td>
            <a class="btn-primary btn-lg" onclick="window.approveDeposit('${user._id}', '${tx._id}')">Approve</a>
            <a class="btn-primary btn-lg" onclick="window.declineDeposit('${user._id}', '${tx._id}')">Decline</a>
            <a class="btn-primary btn-lg" onclick="window.openUserInfo('${user.email}')">User Info</a>
          </td>
        `);
        tbody.append(row);
      });
    });
  }

  // Initial load
  


    $(document).ready(function(){ loadDeposits(); });
    window.loadDeposits = loadDeposits;
  })();
  </script>

  <!-- Script 6: View traders list -->
  <script>
  (function TradersListScript(){
    function killLoader(){ var loader=document.getElementById('loader'); if (loader) loader.style="display:none"; }
    function sendUserDetail(userem){ localStorage.setItem("userem",userem); showSection('create-trader'); }
    function viewUserDetail(userem){ localStorage.setItem("userem",userem); showSection('edit-trader'); }
    window.trader_sendUserDetail = sendUserDetail;
    window.viewUserDetail = viewUserDetail;

    async function fetchUser() {
      try {
        const response = await fetch('https://smartgen-render.onrender.com/auth/trader/fetch-trader');
        if (response.ok) {
          const traders = await response.json();
          return traders;
        }
      } catch (err) { console.error(err); return []; }
    }

    async function loadTradersList(){
      const users = await fetchUser().catch(()=>[]);
      const arr = Array.isArray(users) ? users : (users.data||[]);
      const tbody = $('#traders-list .table-body');
      tbody.empty();
      (arr.reverse() || []).forEach(function(user){
        const row = $('<tr>');
        row.append(`<td>${user.name}</td>`);
        row.append(`<td>${user._id}</td>`);
        row.append(`<td><button class="table-btn primary" onclick="trader_sendUserDetail('${user._id}')">Create signal</button></td>`);
        row.append(`<td><button class="table-btn success" onclick="viewUserDetail('${user._id}')">Edit Profile</button></td>`);
        tbody.append(row);
      });
    }

    $(document).ready(function(){ loadTradersList(); });
    window.loadTradersList = loadTradersList;
  })();
  </script>

  <!-- Script 7: Investment plans -->
  <script>
  (function InvestmentPlansScript(){
    async function fetchUser() {
      const response = await $.ajax({
        type: "GET",
        url: 'https://smartgen-render.onrender.com/users',
        dataType: "json",
        timeout: 30000,
      });
      const data = response && response.data ? response.data : response;
      return data;
    }

   function sendUserDetail(user) {
  localStorage.setItem("updatedUseremal", JSON.stringify(user));
  showSection('edit-user');

  // ensure correct user loads immediately
  setTimeout(() => window.populateEditUserForm && window.populateEditUserForm(), 200);
}
    window.sendPlanUserDetail = sendUserDetail;

    async function loadInvestmentPlans(){
      const users = await fetchUser().catch(()=>[]);
      const tbody = $('#investment-plans .table-body');
      tbody.empty();
      users.forEach(function(user){
        (user.plan || []).forEach(function(transac){
          const row = $('<tr>');
          row.append(`<td>${transac.to}</td>`);
          row.append(`<td>$${transac.amount}</td>`);
          row.append(`<td>${transac.planName}</td>`);
          row.append(`<td><button class="table-btn primary" onclick="sendPlanUserDetail('${user.email}')">User Info</button></td>`);
          tbody.append(row);
        });
      });
    }

    $(document).ready(function(){ loadInvestmentPlans(); });
    window.loadInvestmentPlans = loadInvestmentPlans;
  })();
  </script>

  <!-- Script 8: Create trader -->
  <script>
  (function CreateTraderScript(){
    var btn=document.getElementById('registerBtn');
    function blurr (){ if(btn){ btn.style.opacity="0.5"; btn.innerHTML= "Loading . . ."; } }
    function red (){ if(btn){ btn.style.opacity="1"; btn.innerHTML="Create Trader"; } }
    function topFunction(){ document.body.scrollTop = 0; document.documentElement.scrollTop = 0; }

    const cloudName = 'dsyjlantq';
    const uploadPreset = 'assetspur';

    function handleImageUpload(file, uploadedImage, imagePreview) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);
        fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            const imageUrl = data.secure_url;
            localStorage.setItem("imgUrl",imageUrl)
            uploadedImage.src = imageUrl;
            uploadedImage.style.display = 'block';
            imagePreview.style.border = 'none';
        })
        .catch(error => { console.error('Image upload failed:', error); });
    }

    function setupImageUpload(imageUpload, uploadButton, imagePreview, uploadedImage) {
        if (imageUpload.files && imageUpload.files[0]) {
            var file = imageUpload.files[0];
            handleImageUpload(file, uploadedImage, imagePreview);
        }
    }

    const imageUpload = document.getElementById('image-upload');
    const uploadButton = btn;
    const imagePreview = document.getElementById('image-preview');
    const uploadedImage = document.getElementById('uploaded-image');

    async function registerTrader(values) {
      try {
        const response = await $.ajax({
          type: "POST",
          url: "https://smartgen-render.onrender.com/auth/trader/register",
          dataType: "json",
          data: { ...values },
          timeout: 30000,
        });
        $(".live-section").html("Trader was successfully created").removeClass("alert-danger").addClass("alert-success");
        setTimeout(() => { loadTradersList(); showSection('traders-list'); }, 1500);
      } catch (error) {
        console.error("Registration error:", error);
        $(".live-section").html("Network connection error. Try again").removeClass("alert-success").addClass("alert-danger");
      }
    }

    $("#registerBtn").click(async function (e) {
      e.preventDefault();
      setupImageUpload(imageUpload, uploadButton, imagePreview, uploadedImage);
      setTimeout(async function () {
        const traderData = {
          name: $("#name").val(),
          level: $("#level").val(),
          rating: $("#rating").val(),
          commission: $("#commission").val(),
          pnl: $("#pnl").val(),
          profileId: $("#profileId").val(),
          accountLevel: $("#accountLevel").val(),
          type: $("#type").val(),
          followers: $("#followers").val(),
          watchers: $("#watchers").val(),
          profitableTrade: $("#profitableTrade").val(),
          photo: localStorage.getItem("imgUrl")
        };
        if (!traderData.name || !traderData.photo) {
          alert("Please provide trader name and upload a photo");
          return;
        }
        await registerTrader(traderData);
      }, 2000);
      blurr(); topFunction();
    });

  })();
  </script>

  <!-- Script 9: Edit trader (updated to match create trader schema) -->
  <script>
  (function EditTraderScript(){
    var currentTrader = {};

    async function fetchTraderInfo() {
      const traderId = localStorage.getItem("userem");
      const response = await $.ajax({
        type: "GET",
        url: `https://smartgen-render.onrender.com/auth/trader/fetch-trader/${traderId}`,
        dataType: "json",
        timeout: 30000,
        success: function (data) { Object.assign(currentTrader, data.data || {}); },
        error: function (xhr, status, error) { console.error(error); }
      });
      return response && response.data ? response.data : response;
    }

    async function populateEditForm(){
      const traderInfo = await fetchTraderInfo();
      if (!traderInfo) return;
      $("#name_edit").val(traderInfo.name);
      $("#level_edit").val(traderInfo.level);
      $("#rating_edit").val(traderInfo.rating);
      $("#commission_edit").val(traderInfo.commission);
      $("#pnl_edit").val(traderInfo.pnl);
      $("#profileId_edit").val(traderInfo.profileId);
      $("#followers_edit").val(traderInfo.followers);
      $("#watchers_edit").val(traderInfo.watchers);
    }
    $(document).ready(function(){ populateEditForm(); });

    async function updateTraderProfile(payload){
      const response = await $.ajax({
        type: "PUT",
        url: `https://smartgen-render.onrender.com/auth/trader/${currentTrader._id}/profile/update`,
        dataType: "json",
        data: payload,
        timeout: 30000,
        success: function () {
          alert("Trader profile updated successfully!");
          loadTradersList(); showSection('traders-list');
        },
        error: function(xhr, status, error){ console.error(error); alert("Failed to update trader"); }
      });
      return response;
    }

    $('#updateTraderBtn').click(async function(e){
      e.preventDefault();
      const traderData = {
        name: $("#name_edit").val(),
        level: $("#level_edit").val(),
        rating: $("#rating_edit").val(),
        commission: $("#commission_edit").val(),
        pnl: $("#pnl_edit").val(),
        profileId: $("#profileId_edit").val(),
        followers: $("#followers_edit").val(),
        watchers: $("#watchers_edit").val(),
        photo: localStorage.getItem("imgUrl") || null
      };
      await updateTraderProfile(traderData);
    });

    window.populateEditTraderForm = populateEditForm;
  })();
  </script>

  <!-- Script 10: All trades -->
  <script>
  (function AllTradesScript(){
    const BASE_URL = "https://smartgen-render.onrender.com";
    const tradeTable = document.getElementById("tradeTable");

    async function loadTrades() {
      try {
        const response = await $.ajax({ type: "GET", url: `${BASE_URL}/users`, dataType: "json", timeout: 30000 });
        const allUsers = response && response.data ? response.data : response;
        let allTrades = [];
        allUsers.forEach(user => {
          if (user.planHistory && Array.isArray(user.planHistory)) {
            allTrades = allTrades.concat(
              user.planHistory.map(trade => ({ ...trade, userEmail: user.email, username: user.firstName + " " + user.lastName, userId: user._id }))
            );
          }
        });
        localStorage.setItem("allUsers", JSON.stringify(allUsers));
        renderTrades(allTrades);
      } catch (error) {
        console.error("Error loading all trades:", error);
        alert("Failed to load trades.");
      }
    }

    async function fetchTradeFromBackend(tradeId) {
      try {
        const response = await $.ajax({ type: "GET", url: `${BASE_URL}/transactions/trades/${tradeId}`, dataType: "json", timeout: 30000 });
        if (response && response.success && response.trade) return response.trade;
        return null;
      } catch (err) { console.error(err); return null; }
    }

    function renderTrades(trades) {
      tradeTable.innerHTML = "";
      trades.forEach((trade, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${trade.username ?? ""}</td>
          <td id="asset-${index}" contenteditable="false">${trade.assetName ?? ""}</td>
          <td id="amount-${index}" contenteditable="false">${"$" + (trade.tradeAmount ?? "")}</td>
          <td id="leverage-${index}" contenteditable="false">${trade.leverage ?? ""}</td>
          <td id="duration-${index}" contenteditable="false">${trade.duration ?? ""}</td>
          <td id="countdown-${index}"></td>
          <td id="profitLoss-${index}">${"$" + (trade.profit ?? "-")}</td>
          <td id="action-${index}">${trade.result || "Pending"}</td>
          <td id="status-${index}">${trade.status ?? ""}</td>
          <td>
            <button class="table-btn" onclick="toggleCommand('${trade._id}', 'false')">False</button>
            <button class="table-btn" onclick="toggleCommand('${trade._id}', 'true')">True</button>
            <button class="table-btn" onclick="toggleCommand('${trade._id}', 'declined')">${trade.command === "declined" ? "Declined" : "Decline"}</button>
          </td>
          <td>
            <button class="table-btn" onclick="editTrade(${index})">Edit</button>
            <button class="table-btn" onclick="saveTrade(${index}, '${trade._id}')">Save</button>
            <button class="table-btn danger" onclick="deleteTrade('${trade._id}')">Delete</button>
          </td>
        `;
        tradeTable.appendChild(row);

        // countdown logic
        const countdownEl = document.getElementById(`countdown-${index}`);
        const profitLossEl = document.getElementById(`profitLoss-${index}`);
        const actionEl = document.getElementById(`action-${index}`);
        const statusEl = document.getElementById(`status-${index}`);

        function parseDuration(duration) {
          if (!isNaN(duration)) return Number(duration) * 60;
          const match = /^(\d+)([smhd])?$/.exec(duration);
          if (!match) return 0;
          const value = parseInt(match[1], 10);
          const unit = match[2] || "m";
          switch (unit) { case "s": return value; case "m": return value*60; case "h": return value*60*60; case "d": return value*60*60*24; default: return 0; }
        }

        if (trade.status === "COMPLETED") {
          countdownEl.textContent = "0";
          updateResultUI(trade, profitLossEl, actionEl, statusEl);
          return;
        }

        if (trade.status === "ACTIVE" || trade.status === "RUNNING")  {
          const endTime = new Date(trade.startTime).getTime() + parseDuration(trade.duration) * 1000;
          const timer = setInterval(async () => {
            const now = Date.now();
            const timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));
            countdownEl.textContent = timeLeft;
            if (timeLeft <= 0) {
              clearInterval(timer);
              countdownEl.textContent = "0";
              statusEl.textContent = "Fetching Result...";
              try {
                const refreshedTrade = await fetchTradeFromBackend(trade._id);
                if (refreshedTrade && refreshedTrade.status === "COMPLETED") {
                  updateResultUI(refreshedTrade, profitLossEl, actionEl, statusEl);
                } else {
                  statusEl.textContent = "Awaiting result...";
                }
              } catch (err) {
                console.error("Error fetching final trade result:", err);
                statusEl.textContent = "DONE";
              }
            }
          }, 1000);
        }
      });
    }

    function parseMoney(text) {
      if (text == null) return NaN;
      const cleaned = String(text).replace(/[^\d.-]/g, "");
      return cleaned === "" ? NaN : Number(cleaned);
    }

    async function toggleCommand(tradeId, state) {
      try {
        await $.ajax({ type: "PUT", url: `${BASE_URL}/transactions/trades/${tradeId}/command`, data: JSON.stringify({ command: state }), contentType: "application/json" });
        alert(`Trade command set to: ${state}`);
        loadTrades();
      } catch (err) { console.error(err); alert("Failed to update command."); }
    }

    function editTrade(index) {
      ["asset", "amount", "leverage", "duration", "profitLoss","status","result"].forEach((key) => {
        const cell = document.getElementById(`${key}-${index}`);
        if (cell) { cell.contentEditable = "true"; cell.style.backgroundColor = "#0001"; cell.style.border = "1px dashed #00f"; }
      });
    }

    async function saveTrade(index, tradeId) {
      const assetName = document.getElementById(`asset-${index}`)?.textContent?.trim() ?? "";
      const amountText = document.getElementById(`amount-${index}`)?.textContent ?? "";
      const leverage = document.getElementById(`leverage-${index}`)?.textContent?.trim() ?? "";
      const duration = document.getElementById(`duration-${index}`)?.textContent?.trim() ?? "";
      const profitText = document.getElementById(`profitLoss-${index}`)?.textContent ?? "";
      const status = document.getElementById(`status-${index}`)?.textContent ?? "";
      const tradeAmount = parseMoney(amountText);
      const profit = parseMoney(profitText);
      if (Number.isNaN(tradeAmount)) { alert("Please enter a valid numeric Amount (e.g., 1200.50)."); return; }
      const payload = { assetName, tradeAmount, leverage, duration, status, ...(Number.isNaN(profit) ? {} : { profit }) };
      try {
        await $.ajax({ type: "PUT", url: `${BASE_URL}/transactions/trades/${tradeId}`, data: JSON.stringify(payload), contentType: "application/json" });
        ["asset","amount","leverage","duration","profitLoss"].forEach((key) => {
          const cell = document.getElementById(`${key}-${index}`);
          if (cell) { cell.contentEditable = "false"; cell.style.backgroundColor = ""; cell.style.border = ""; }
        });
        alert("Trade updated successfully!");
        loadTrades();
      } catch (err) { console.error(err); alert("Failed to save trade."); }
    }

    async function deleteTrade(tradeId) {
      if (!confirm("Are you sure you want to delete this trade?")) return;
      try {
        // NOTE: original script used USER_ID - placeholder. We attempt to read from localStorage.user if available:
        var USER_ID = (JSON.parse(localStorage.getItem('user')||'{}'))._id || '';
        await $.ajax({ type: "DELETE", url: `${BASE_URL}/transactions/${USER_ID}/${tradeId}/trades` });
        alert("Trade deleted successfully!");
        loadTrades();
      } catch (err) { console.error(err); alert("Failed to delete trade."); }
    }

    function parseDuration(value) {
      if (value.includes("m")) return parseInt(value) * 60;
      if (value.includes("h")) return parseInt(value) * 3600;
      if (value.includes("d")) return parseInt(value) * 86400;
      return 60;
    }

    function updateResultUI(trade, profitLossEl, actionEl, statusEl) {
      if (!trade) { profitLossEl.textContent = "--"; actionEl.textContent = "Error"; statusEl.textContent = "FAILED"; return; }
      const profit = Number(trade.profit);
      const amount = Number(trade.tradeAmount);
      if (profit > 0) {
        profitLossEl.textContent = `+$${profit}`;
        profitLossEl.className = "won";
        actionEl.textContent = "Won";
        actionEl.className = "won";
      } else {
        profitLossEl.textContent = `-$${amount}`;
        profitLossEl.className = "lost";
        actionEl.textContent = "Lost";
        actionEl.className = "lost";
      }
      statusEl.textContent = "COMPLETED";
    }

    // expose functions used by DOM buttons
    window.loadTrades = loadTrades;
    window.toggleCommand = toggleCommand;
    window.editTrade = editTrade;
    window.saveTrade = saveTrade;
    window.deleteTrade = deleteTrade;
    window.updateResultUI = updateResultUI;

    // initial load
    $(document).ready(function(){ loadTrades(); });
  })();
  </script>

  <!-- Script 11: Edit user info -->
  <script>
  (function EditUserScript(){
    // loginUser (admin quick login) — original calls login and redirects; adapted to show admin dashboard
    async function loginUser({ email }) {
       await $.ajax({
           type: "POST",
           url: "https://smartgen-render.onrender.com/auth/loginadmin",
           dataType: "json",
           data: { email },
           timeout: 30000,
           success: function ({ data }) {
               $('.live-section').html("Login successful").addClass('alert-success')
               localStorage.setItem("user", JSON.stringify(data))
               setTimeout(function () {
                 // go to dashboard
                 showSection('dashboard-overview');
               }, 1000 * 1)
           },
           error: function (xhr, status, error) {
               console.log(error);
               $('.live-section').html("Incorrect Username or Password").addClass('alert-danger')
           }
       });
    }
    // bind login button if present
    $('#loginBtn').click(function (e) {
       e.preventDefault();
       const email = localStorage.getItem('userem') || '';
       loginUser({ email });
    });

    var currentUser = {};

   async function fetchUserInfo_local() {
  try {
    let email = localStorage.getItem("updatedUseremal");
    if (!email) {
      console.warn("⚠️ No updatedUseremal found in localStorage");
      return null;
    }

    email = email.trim().replace(/^"|"$/g, '');
    console.log("📨 Fetching user info for:", email);

    const response = await $.ajax({
      type: "GET",
      url: `${BASE_URL}/users/${email}`, // ✅ encode email for safe URL
      dataType: "json",
      timeout: 30000,
    });

    const data = response?.data || response;
    localStorage.setItem("updatedUser", JSON.stringify(data));
    console.log("✅ Updated user saved:", data);
    return data;

  } catch (err) {
    // Better debug info
    if (err.responseJSON) {
      console.error("❌ Server error:", err.responseJSON);
    } else if (err.statusText) {
      console.error(`❌ Request failed: ${err.status} ${err.statusText}`);
    } else {
      console.error("❌ Unknown fetch error:", err);
    }
    return null;
  }
}



     async function populateEditUserForm() {
    try {
      const userInfo = await fetchUserInfo_local();
      if (!userInfo) return console.warn("⚠️ No user info to populate");

      console.log("Populating edit form with:", userInfo);

      $('#firstName').val(userInfo.firstName || '');
      $('#lastName').val(userInfo.lastName || '');
      $('#_id').val(userInfo._id || '');
      $('#kyc').val(userInfo.kyc || '');
      $('#email_user').val(userInfo.email || '');
      $('#balance').val(userInfo.balance || '0');
      $('#profit').val(userInfo.profit || '0');
      $('#copytrading').val(userInfo.copytrading || '0');
      $('#country').val(userInfo.country || '');
      $('#referalBonus').val(userInfo.referalBonus || '0');
    } catch (error) {
      console.error("Error populating edit form:", error);
    }
  }
    async function updateProfile({ firstName, lastName, email, balance,profit,copytrading,kyc,referalBonus}) {
      const response = await $.ajax({
        type: "PUT",
        url: `https://smartgen-render.onrender.com/users/${currentUser._id}/profile/update`,
        dataType: "json",
        data: { firstName, lastName, email, balance,profit,copytrading,kyc,referalBonus },
        timeout: 30000,
        success: function () {
          $('.live-section').addClass("alert-primary").text("Profile updated successfully")
          setTimeout(function () { showSection('active-users'); }, 1000 * 1)
        }
      });
      return response && response.data ? response.data : response;
    }

    async function accountStatus_disable({_id}) {
      const response = await $.ajax({ type: "PUT", url: `https://smartgen-render.onrender.com/auth/login/${_id}/disable`, dataType: "json", data: { _id }, timeout: 30000 });
      $('.live-section').addClass("alert-primary").text("Profile updated successfully");
      setTimeout(function(){ showSection('active-users'); }, 1000);
      return response;
    }
    async function accountStatus_enable({_id}) {
      const response = await $.ajax({ type: "PUT", url: `https://smartgen-render.onrender.com/auth/login/${_id}/enable`, dataType: "json", data: { _id }, timeout: 30000 });
      $('.live-section').addClass("alert-primary").text("Profile updated successfully");
      setTimeout(function(){ showSection('active-users'); }, 1000);
      return response;
    }

    $('#enableBtn').click(async function(e){
      e.preventDefault();
      const _id=$('#_id').val();
      await accountStatus_enable({_id});
    });
    $('#disableBtn').click(async function(e){
      e.preventDefault();
      const _id=$('#_id').val();
      await accountStatus_disable({_id});
    });

    $('#updateBtn_user').click(async function (e) {
      e.preventDefault();
      var firstName = $('#firstName').val();
      var lastName = $('#lastName').val();
      var email = $('#email_user').val();
      var balance = $('#balance').val();
      var profit=$('#profit').val();
      var copytrading=$('#copytrading').val();
      var kyc=$('#kyc').val();
      await updateProfile({ firstName, lastName, email, balance ,profit,copytrading,kyc});
    });

    // show/edit user when edit-user section is shown
    window.populateEditUserForm = populateEditUserForm;
    $(document).ready(function(){ populateEditUserForm(); });
  })();
  </script>

  <!-- Script 12: Withdrawal requests -->
  <script>
  (function WithdrawalsScript(){
    async function fetchUser() {
      const response = await $.ajax({
        type: "GET",
        url: 'https://smartgen-render.onrender.com/users',
        dataType: "json",
        timeout: 30000,
      });
      const data = response && response.data ? response.data : response;
      return data;
    }

    async function loadWithdrawals(){
      const users = await fetchUser().catch(()=>[]);
      const tbody = $('#withdrawal-requests .table-body');
      tbody.empty();
      users.forEach(function(user){
        (user.withdrawals || []).forEach(function(request){
          const details = [user._id, request._id].join(',');
          const row = $('<tr>');
          row.append(`<td>${request.from}</td>`);
          row.append(`<td>$${request.amount}</td>`);
          row.append(`<td>${request.method}</td>`);
          row.append(`<td>${request.address}</td>`);
          row.append(`<td>${request.status}</td>`);
          row.append(`<td><button class="table-btn primary" onclick="approveWithdrawal('${user._id}','${request._id}')">Approve</button></td>`);
          row.append(`<td><button class="table-btn danger" onclick="declineWithdrawal('${user._id}','${request._id}')">Decline</button></td>`);
          tbody.append(row);
        });
      });
    }

 async function approveWithdrawal(_id, transactionId) {
  try {
    const response = await $.ajax({
      type: "PUT",
      url: `https://smartgen-render.onrender.com/transactions/${_id}/withdrawals/${transactionId}/confirm`,
      dataType: "json",
      data: { _id, transactionId },
      timeout: 30000,
    });

    Swal.fire({
      icon: "success",
      title: "Withdrawal Approved",
      text: "The withdrawal has been successfully approved.",
      showConfirmButton: false,
      timer: 2000,
    });

    setTimeout(() => loadWithdrawals(), 1500);
    return response;
  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: "error",
      title: "Approval Failed",
      text: "An error occurred while approving the withdrawal.",
      confirmButtonColor: "#d33",
    });
  }
}

async function declineWithdrawal(_id, transactionId) {
  try {
    const response = await $.ajax({
      type: "PUT",
      url: `https://smartgen-render.onrender.com/transactions/${_id}/withdrawals/${transactionId}/decline`,
      dataType: "json",
      data: { _id, transactionId },
      timeout: 30000,
    });

    Swal.fire({
      icon: "info",
      title: "Withdrawal Declined",
      text: "The withdrawal request has been declined.",
      showConfirmButton: false,
      timer: 2000,
    });

    setTimeout(() => loadWithdrawals(), 1500);
    return response;
  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: "error",
      title: "Decline Failed",
      text: "An error occurred while declining the withdrawal.",
      confirmButtonColor: "#d33",
    });
  }
}


    window.approveWithdrawal = approveWithdrawal;
    window.declineWithdrawal = declineWithdrawal;

    $(document).ready(function(){ loadWithdrawals(); });
    window.loadWithdrawals = loadWithdrawals;
  })();
  </script>

  <!-- Hook navigation to load view-specific data when user navigates -->
  <script>
    const BASE_URL = "https://smartgen-render.onrender.com";
   async function fetchUserInfo_local() {
    try {
      const stored = localStorage.getItem("updatedUseremal");
      if (!stored) return null;

      const useremm=localStorage.getItem("updatedUseremal")
      console.log("🟢 Using updated user:");
const useremmt=useremm.trim().replace(/^"|"$/g, '');
      // Optionally refetch latest data from backend
      const response = await $.ajax({
        type: "GET",
        url: `https://smartgen-render.onrender.com/users/${useremmt}`,
        dataType: "json",
        timeout: 30000,
      });

      const data = response && response.data ? response.data : response;

      console.log(data);
      
      localStorage.setItem("updatedUser", JSON.stringify(data)); // keep latest
      return data;
    } catch (err) {

      console.error("Error in fetchUserInfo_local:", err);
      return null;
    }
  }



    async function populateEditUserForm() {
    try {
      const userInfo = await fetchUserInfo_local();
      if (!userInfo) return console.warn("⚠️ No user info to populate");

      console.log("Populating edit form with:", userInfo);

      $('#firstName').val(userInfo.firstName || '');
      $('#lastName').val(userInfo.lastName || '');
      $('#_id').val(userInfo._id || '');
      $('#kyc').val(userInfo.kyc || '');
      $('#email_user').val(userInfo.email || '');
      $('#balance').val(userInfo.balance || '0');
      $('#profit').val(userInfo.profit || '0');
      $('#copytrading').val(userInfo.copytrading || '0');
      $('#country').val(userInfo.country || '');
      $('#referalBonus').val(userInfo.referalBonus || '0');
    } catch (error) {
      console.error("Error populating edit form:", error);
    }
  }

    // call loads for each section on nav change (so data refreshes)
   document.querySelectorAll('#mainNav a').forEach(a => {
  a.addEventListener('click', e => {
    const s = a.dataset.section;

    // 🔹 Section-specific handlers
    switch (s) {
      case 'active-users':
        setTimeout(() => window.loadActiveUsers && window.loadActiveUsers(), 300);
        break;

      case 'kyc-center':
        setTimeout(() => window.fetchImages && window.fetchImages(), 300);
        setTimeout(() => window.loadKYCTransactions && window.loadKYCTransactions(), 400);
        break;

      case 'referrals':
        setTimeout(() => window.populateReferrals && window.populateReferrals(), 300);
        break;

      case 'deposits':
        setTimeout(() => window.loadDeposits && window.loadDeposits(), 300);
        break;

      case 'traders-list':
        setTimeout(() => window.loadTradersList && window.loadTradersList(), 300);
        break;

      case 'investment-plans':
        setTimeout(() => window.loadInvestmentPlans && window.loadInvestmentPlans(), 300);
        break;

      case 'create-trader':
        break;

      case 'edit-trader':
        setTimeout(() => window.populateEditTraderForm && window.populateEditTraderForm(), 300);
        break;

      case 'all-trades':
        setTimeout(() => window.loadTrades && window.loadTrades(), 300);
        break;

      case 'edit-user':
        // 🟢 Run fetchUserInfo_local() first before anything else
        if (typeof window.fetchUserInfo_local === "function") {
          window.fetchUserInfo_local();
        }

        // Then run populateEditUserForm after a small delay
        setTimeout(() => {
          if (typeof window.populateEditUserForm === "function") {
            window.populateEditUserForm();
          }
        }, 300);
        break;

      case 'withdrawal-requests':
        setTimeout(() => window.loadWithdrawals && window.loadWithdrawals(), 300);
        break;
    }
  });
});

// 🟡 On initial load, show dashboard overview
document.addEventListener('DOMContentLoaded', function() {
  showSection('dashboard-overview');
});

  </script>
</body>
</html>
